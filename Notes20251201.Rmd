---
title: "Notes20251201"
author: "Blazej Kochanski"
date: "2025-12-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Working with data - tips and tricks

### Saving the data after preprocessing

Example:

```{r preprocessing, eval=FALSE}
load(url("https://github.com/pbiecek/Diagnoza/raw/master/data/osoby.rda"))
extract <- osoby[, c('numer_gd', 'numer_osoby', 'hc5', 'hc6', 'hc10', 
                     'hp65', 'hp52', 'hp53', 'waga_2015_ind', 'wiek2015')]
names(extract) <- c('household_id', 'person_id', 'family_no', 'family_role', 
                    'sex', 'income', 'height', 'weight', 'survey_weight', 'age')
extract$income[is.na(extract$income)] <- -1
extract <- na.omit(extract)
extract$income[extract$income == -1] <- NA
extract$family_id <- paste(extract$household_id, extract$family_no)
extract_husband <- extract[(extract$family_role == 1 | extract$family_role == 2) &  extract$sex == 1, 
                           c('family_id', 'income', 'height', 'weight', 'survey_weight', 'age')]
names(extract_husband) <- c('family_id', 'husband_income', 'husband_height', 'husband_weight', 
                            'husband_survey_weight', 'husband_age')

extract_wife <- extract[(extract$family_role == 1 | extract$family_role == 2) & extract$sex == 2, 
                        c('family_id', 'income', 'height', 'weight', 'survey_weight', 'age')]
names(extract_wife) <- c('family_id', 'wife_income', 'wife_height', 'wife_weight', 
                         'wife_survey_weight', 'wife_age')
e <- merge(extract_husband, extract_wife)
e$avg_survey_weight <- (e$husband_survey_weight + e$wife_survey_weight)/2
e$avg_survey_weight <- e$avg_survey_weight / mean(e$avg_survey_weight)
saveRDS(e, "my_data.rds")
```

In the code above, the data is downloaded from the internet, processed, and then the final, relatively small, table `e` is saved in the `my_data.rds` file. I set `eval=FALSE` in the code chunk above, so that it is not run each time I knit the Rmarkdown file. If I want to use the preprocessed data, I just read it from the `my_data.rds` file:

```{r}
my_data <- readRDS("my_data.rds")
```

or even directly from github:

```{r, eval=FALSE}
my_data <- readRDS(url("https://github.com/blakocha/DAR2025/raw/main/my_data.rds"))
```

... and I can work from here. For example:

```{r}
summary(lm(husband_income~husband_height+wife_height, data=my_data))
```

It seems there is a weak but statistically significant association between men's income and men's height as well his wife's height!

## Processing the data frames

I would like to have a data frame where the husband income is above 2000 and is not null. 

The code follows this structure `mydataframe[rules for rows , rules for columns]`: 

```{r}
my_data2 <- my_data[!is.na(my_data$husband_income) & my_data$husband_income>2000 , ]
mean(my_data2$husband_income)
```

```{r}
my_data3 <- my_data[ , c("family_id", "husband_income", "wife_income")]
```

If you need to merge two tables, use `merge()`. See above for the example. 

## Using the `dplyr` package

Calculate the average, minimum, and maximum miles per gallon `mpg` rating by number of cylinders `cyl`. 

```{r warning=FALSE}
data(mtcars)
head(mtcars)

library(dplyr)

mtcars %>%
  group_by(cyl) %>%
  summarise(avg_mpg = mean(mpg), min_mpg = min(mpg), max_mpg=max(mpg))

```


Let us use `mutate` to create a column saying wether the car is heavy or light. `wt>3` would be `heavy`. 

```{r warning=FALSE}
mtcars %>%
  mutate(wt_group = ifelse(wt>3, "heavy", "not heavy")) %>%
  group_by(wt_group) %>%
  summarise(avg_mpg = mean(mpg), min_mpg = min(mpg), max_mpg=max(mpg))

```

In dplyr, use select if you want to have just a few columns in the resulting data frame. 

```{r warning=FALSE}
mtcars %>%
  select(wt, hp) %>%
  cor()
```